<div class="w-full">
  <% if notice.present? %>
    <p class="py-2 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-lg inline-block" id="notice"><%= notice %></p>
  <% end %>


  <!-- Search and Filters -->
  <div class="bg-gray-50 p-4 rounded-lg mb-4 flex justify-around">
    <%= form_tag admin_user_lists_path, method: :get, local: true, class: "flex flex-wrap items-end justify-center gap-4" do %>
      <!-- Search -->
      <div>
        <%= label_tag :search, "Navn, e-post eller organisasjon:", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= text_field_tag :search, @permitted_params[:search], placeholder: "", class: "mt-1 block w-80 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
      </div>

      <!-- Type Filter -->
      <div>
        <%= label_tag :type, "Type:", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= select_tag :type, 
            options_for_select([
              ["Alle", ""],
              ["Mennesker", "humans"],
              ["Roboter", "robots"]
            ], @permitted_params[:type]), 
            class: "mt-1 block w-44 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
      </div>

      <!-- Organization Filter -->
      <div>
        <%= label_tag :organization_names, "Organisasjoner:", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= select_tag :organization_names,
            options_for_select(@available_organizations.map { |org| [org, org] }, @permitted_params[:organization_names]),
            {
              multiple: true,
              class: "mt-1 block w-80 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              data: {
                controller: "tom-select",
                tom_select_options_value: {
                  plugins: ["remove_button"],
                  placeholder: "Velg organisasjoner..."
                }.to_json
              }
            } %>
      </div>

      <!-- Admin Filter -->
      <div>
        <%= label_tag :admin, "Admin:", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= select_tag :admin, 
            options_for_select([
              ["Alle", ""],
              ["Admin", "true"],
              ["Ikke admin", "false"]
            ], @permitted_params[:admin]), 
            class: "mt-1 block w-44 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
      </div>

      <!-- Date Range Filter -->
      <div>
        <%= label_tag :start_date, "Opprettet fra:", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= date_field_tag :start_date, @permitted_params[:start_date], class: "mt-1 block w-44 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
      </div>
      
      <div>
        <%= label_tag :end_date, "Opprettet til:", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= date_field_tag :end_date, @permitted_params[:end_date], class: "mt-1 block w-44 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
      </div>

      <div class="flex items-center gap-4">
        <%= submit_tag "Filtrer", class: "button" %>
        <% if @permitted_params[:search].present? || @permitted_params[:type].present? || @permitted_params[:admin].present? || @permitted_params[:start_date].present? || @permitted_params[:end_date].present? || @permitted_params[:organization_names].present? %>
          <%= link_to "Fjern filter", admin_user_lists_path, class: "text-gray-600 hover:text-gray-900" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="my-4">
    <%== pagy_info(@pagy, item_name: "brukere") %>
    <%== pagy_nav(@pagy) %>
  </div>

  <!-- Users Table -->
  <div class="bg-white shadow overflow-hidden rounded-lg 2xl:px-10">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= link_to "Navn", admin_user_lists_path(@permitted_params.except(:sort_by, :sort_direction).merge(sort_by: "name", sort_direction: @permitted_params[:sort_direction] == "asc" ? "desc" : "asc")), 
                class: "hover:text-lnu-blue" %>
            <% if @permitted_params[:sort_by] == "name" %>
              <%= @permitted_params[:sort_direction] == "asc" ? "↑" : "↓" %>
            <% end %>
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= link_to "E-post", admin_user_lists_path(@permitted_params.except(:sort_by, :sort_direction).merge(sort_by: "email", sort_direction: @permitted_params[:sort_direction] == "asc" ? "desc" : "asc")), 
                class: "hover:text-lnu-blue" %>
            <% if @permitted_params[:sort_by] == "email" %>
              <%= @permitted_params[:sort_direction] == "asc" ? "↑" : "↓" %>
            <% end %>
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= link_to "Organisasjon", admin_user_lists_path(@permitted_params.except(:sort_by, :sort_direction).merge(sort_by: "organization", sort_direction: @permitted_params[:sort_direction] == "asc" ? "desc" : "asc")), 
                class: "hover:text-lnu-blue" %>
            <% if @permitted_params[:sort_by] == "organization" %>
              <%= @permitted_params[:sort_direction] == "asc" ? "↑" : "↓" %>
            <% end %>
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= link_to "Type", admin_user_lists_path(@permitted_params.except(:sort_by, :sort_direction).merge(sort_by: "type", sort_direction: @permitted_params[:sort_direction] == "asc" ? "desc" : "asc")), 
                class: "hover:text-lnu-blue" %>
            <% if @permitted_params[:sort_by] == "type" %>
              <%= @permitted_params[:sort_direction] == "asc" ? "↑" : "↓" %>
            <% end %>
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= link_to "Admin", admin_user_lists_path(@permitted_params.except(:sort_by, :sort_direction).merge(sort_by: "admin", sort_direction: @permitted_params[:sort_direction] == "asc" ? "desc" : "asc")), 
                class: "hover:text-lnu-blue" %>
            <% if @permitted_params[:sort_by] == "admin" %>
              <%= @permitted_params[:sort_direction] == "asc" ? "↑" : "↓" %>
            <% end %>
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= link_to "Opprettet", admin_user_lists_path(@permitted_params.except(:sort_by, :sort_direction).merge(sort_by: "created_at", sort_direction: @permitted_params[:sort_direction] == "asc" ? "desc" : "asc")), 
                class: "hover:text-lnu-blue" %>
            <% if @permitted_params[:sort_by] == "created_at" || @permitted_params[:sort_by].blank? %>
              <%= @permitted_params[:sort_direction] == "asc" ? "↑" : "↓" %>
            <% end %>
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @users.each do |user| %>
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <%= image_tag user.gravatar_url, alt: user.name, class: "h-10 w-10 rounded-full" %>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">
                    <%= user.name || "Ingen navn" %>
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm flex gap-1.5 text-gray-900"><%= user.email %><%= link_to "mailto:#{user.email}" do %><%= inline_svg "email", class: "hover:bg-lnu-pink hover:text-white rounded-full" %><% end %></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">
                <%= user.organization_name.presence || "-" %>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full <%= user.robot? ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800' %>">
                <%= user.robot? ? "Robot" : "Menneske" %>
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% if user.admin? %>
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                  Admin
                </span>
              <% else %>
                <span class="text-gray-400">-</span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= l(user.created_at, format: :short) %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="my-4">
    <%== pagy_info(@pagy, item_name: "brukere") %>
    <%== pagy_nav(@pagy) %>
  </div>
</div>