<div class="w-full">
  <% if notice.present? %>
    <p class="py-2 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-lg inline-block" id="notice"><%= notice %></p>
  <% end %>

  <div class="flex justify-between items-center mb-6">
    <h1 class="font-bold text-lnu-blue text-3xl">Brukere</h1>
    <div class="text-gray-600">
      <%= @pagy.count %> brukere totalt
    </div>
  </div>

  <!-- Search and Filters -->
  <%= form_tag admin_user_lists_path, method: :get, local: true, class: "bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6" do %>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
      <!-- Search -->
      <div>
        <%= label_tag :search, "Søk", class: "label" %>
        <%= text_field_tag :search, @permitted_params[:search], placeholder: "Navn, e-post eller organisasjon", class: "text_field" %>
      </div>

      <!-- Type Filter -->
      <div>
        <%= label_tag :type, "Type", class: "label" %>
        <%= select_tag :type, 
            options_for_select([
              ["Alle", ""],
              ["Mennesker", "humans"],
              ["Roboter", "robots"]
            ], @permitted_params[:type]), 
            class: "select_field" %>
      </div>

      <!-- Organization Filter -->
      <div>
        <%= label_tag :organization_names, "Organisasjoner", class: "label" %>
        <%= select_tag :organization_names,
            options_for_select(@available_organizations.map { |org| [org, org] }, @permitted_params[:organization_names]),
            {
              multiple: true,
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              data: {
                controller: "tom-select",
                tom_select_options_value: {
                  plugins: ["remove_button"],
                  placeholder: "Velg organisasjoner..."
                }.to_json
              }
            } %>
      </div>

      <!-- Admin Filter -->
      <div>
        <%= label_tag :admin, "Admin", class: "label" %>
        <%= select_tag :admin, 
            options_for_select([
              ["Alle", ""],
              ["Admin", "true"],
              ["Ikke admin", "false"]
            ], @permitted_params[:admin]), 
            class: "select_field" %>
      </div>
    </div>

    <!-- Date Range Filter -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <%= label_tag :start_date, "Opprettet fra", class: "label" %>
        <%= date_field_tag :start_date, @permitted_params[:start_date], class: "text_field" %>
      </div>
      <div>
        <%= label_tag :end_date, "Opprettet til", class: "label" %>
        <%= date_field_tag :end_date, @permitted_params[:end_date], class: "text_field" %>
      </div>
    </div>

    <div class="flex gap-2">
      <%= submit_tag "Filtrer", class: "button" %>
      <%= link_to "Nullstill", admin_user_lists_path, class: "button bg-gray-500 hover:bg-gray-600" %>
    </div>
  <% end %>

  <!-- Users Table -->
  <div class="bg-white shadow overflow-hidden rounded-lg">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= link_to "Navn", admin_user_lists_path(@permitted_params.except(:sort_by, :sort_direction).merge(sort_by: "name", sort_direction: @permitted_params[:sort_direction] == "asc" ? "desc" : "asc")), 
                class: "hover:text-lnu-blue" %>
            <% if @permitted_params[:sort_by] == "name" %>
              <%= @permitted_params[:sort_direction] == "asc" ? "↑" : "↓" %>
            <% end %>
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= link_to "E-post", admin_user_lists_path(@permitted_params.except(:sort_by, :sort_direction).merge(sort_by: "email", sort_direction: @permitted_params[:sort_direction] == "asc" ? "desc" : "asc")), 
                class: "hover:text-lnu-blue" %>
            <% if @permitted_params[:sort_by] == "email" %>
              <%= @permitted_params[:sort_direction] == "asc" ? "↑" : "↓" %>
            <% end %>
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= link_to "Organisasjon", admin_user_lists_path(@permitted_params.except(:sort_by, :sort_direction).merge(sort_by: "organization", sort_direction: @permitted_params[:sort_direction] == "asc" ? "desc" : "asc")), 
                class: "hover:text-lnu-blue" %>
            <% if @permitted_params[:sort_by] == "organization" %>
              <%= @permitted_params[:sort_direction] == "asc" ? "↑" : "↓" %>
            <% end %>
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= link_to "Type", admin_user_lists_path(@permitted_params.except(:sort_by, :sort_direction).merge(sort_by: "type", sort_direction: @permitted_params[:sort_direction] == "asc" ? "desc" : "asc")), 
                class: "hover:text-lnu-blue" %>
            <% if @permitted_params[:sort_by] == "type" %>
              <%= @permitted_params[:sort_direction] == "asc" ? "↑" : "↓" %>
            <% end %>
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= link_to "Admin", admin_user_lists_path(@permitted_params.except(:sort_by, :sort_direction).merge(sort_by: "admin", sort_direction: @permitted_params[:sort_direction] == "asc" ? "desc" : "asc")), 
                class: "hover:text-lnu-blue" %>
            <% if @permitted_params[:sort_by] == "admin" %>
              <%= @permitted_params[:sort_direction] == "asc" ? "↑" : "↓" %>
            <% end %>
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= link_to "Opprettet", admin_user_lists_path(@permitted_params.except(:sort_by, :sort_direction).merge(sort_by: "created_at", sort_direction: @permitted_params[:sort_direction] == "asc" ? "desc" : "asc")), 
                class: "hover:text-lnu-blue" %>
            <% if @permitted_params[:sort_by] == "created_at" || @permitted_params[:sort_by].blank? %>
              <%= @permitted_params[:sort_direction] == "asc" ? "↑" : "↓" %>
            <% end %>
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @users.each do |user| %>
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <%= image_tag user.gravatar_url, alt: user.name, class: "h-10 w-10 rounded-full" %>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">
                    <%= user.name || "Ingen navn" %>
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900"><%= user.email %></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">
                <%= user.organization_name.presence || "-" %>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full <%= user.robot? ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800' %>">
                <%= user.robot? ? "Robot" : "Menneske" %>
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% if user.admin? %>
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                  Admin
                </span>
              <% else %>
                <span class="text-gray-400">-</span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= l(user.created_at, format: :short) %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="mt-6">
    <%== pagy_nav(@pagy) %>
  </div>
</div>